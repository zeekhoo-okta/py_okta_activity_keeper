{% extends "base.html" %}

{% block title %}Home{% endblock title %}

{% block head %}
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
	<script src="https://ok1static.oktacdn.com/assets/js/sdk/okta-signin-widget/1.7.0/js/okta-sign-in.min.js" type="text/javascript"></script>
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
{% endblock %}
{% block page_css %}
	<link href="https://ok1static.oktacdn.com/assets/js/sdk/okta-signin-widget/1.7.0/css/okta-sign-in.min.css" type="text/css" rel="stylesheet">
	<link href="https://ok1static.oktacdn.com/assets/js/sdk/okta-signin-widget/1.7.0/css/okta-theme.css" type="text/css" rel="stylesheet">
{% endblock %}


{% block content %}
<div class="login-pg">
	{% csrf_token %}
  <div id="okta-login-container"></div>
</div>
{% endblock %}

{% block page_js %}
	<script type="text/javascript">
		function getCookie(name) {
			var cookieValue = null;
			if (document.cookie && document.cookie !== '') {
				var cookies = document.cookie.split(';');
				for (var i = 0; i < cookies.length; i++) {
					var cookie = jQuery.trim(cookies[i]);
					// Does this cookie string begin with the name we want?
					if (cookie.substring(0, name.length + 1) === (name + '=')) {
						cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
						break;
					}
				}
			}
			return cookieValue;
		}
		var csrftoken = getCookie('csrftoken');

		var baseUrl = 'https://zeekhoo.okta.com';
		var redirectUrl = '/task'
		var oktaSignIn = new OktaSignIn(
			{
				baseUrl: baseUrl,
				features: {
					rememberMe: true,
					smsRecovery: true,
					multiOptionalFactorEnroll: true
				},
				labels: {
					'primaryauth.title': 'Please Sign-In',
					'help': 'Click here for more help'
				}
			}
		);

		oktaSignIn.session.exists(function (exists) {
			if (exists) {
				//window.location = redirectUrl;
				//return;
			}

			oktaSignIn.renderEl(
				{ el: '#okta-login-container' },
				function (res) {
					if (res.status === 'SUCCESS') {
						//res.session.setCookieAndRedirect(redirectUrl);
						$.ajaxSetup({
							headers: { "X-CSRFToken": getCookie("csrftoken") }
						});
						$.post("/login/", JSON.stringify(res.user), function(data) {
                			window.location.href="/task/";
              			});
					}
				},
				function (err) {
					console.log('Unexpected error authenticating user: %o', err);
				}
			);
		});
	</script>
{% endblock page_js %}

